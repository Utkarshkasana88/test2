import cats.effect.IO
import cats.effect.unsafe.implicits.global
import dev.kubukoz.otel4s._
import dev.kubukoz.otel4s.opentelemetry.sdk._
import dev.kubukoz.otel4s.opentelemetry.exporters.otlp.grpc.OtlpGrpcSpanExporter

import org.typelevel.log4cats.LoggerFactory

object OtelApp extends IOApp.Simple {

  override def run: IO[Unit] = {

    val connectionString =
      s"InstrumentationKey=<AI_INSTRUMENTATION_KEY>"

    val endpoint =
      "https://<region>.monitor.azure.com:4317"

    val resource = Resource[IO].fromAutoCloseable(IO {
      // Build OTLP exporter
      val exporter = OtlpGrpcSpanExporter
        .Builder()
        .setEndpoint(endpoint)
        .addHeader("Authorization", connectionString)
        .build()

      OpenTelemetrySdkAutoConfigure
        .initialize()
        .toOtelJava
    })

    resource.use { otel =>
      Otel4s.fromJava(otel).flatMap { implicit o4s =>

        val logger = LoggerFactory.getLogger[IO]

        for {
          _ <- logger.info("Test log from Databricks using OTEL â†’ Azure!")
        } yield ()
      }
    }
  }
}

OtelApp.run.unsafeRunSync()



dev.kubukoz:otel4s-core_2.12:0.5.0
dev.kubukoz:otel4s-otlp-grpc-exporter_2.12:0.5.0
io.opentelemetry:opentelemetry-exporter-otlp:1.39.0
io.opentelemetry:opentelemetry-sdk:1.39.0
io.grpc:grpc-netty-shaded:1.64.0

