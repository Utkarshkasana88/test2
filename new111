âœ… STEP 1 â€” VERIFY CONNECTION STRING IS ACTUALLY USED

Run THIS EXACT CELL in Databricks:

println("ENV VAR = " + sys.env.get("APPLICATIONINSIGHTS_CONNECTION_STRING"))

âœ… Expected
Some(InstrumentationKey=...;IngestionEndpoint=...)

âŒ If you see
None


â¡ STOP
You must set it at cluster level:

Cluster â†’ Advanced â†’ Environment Variables

APPLICATIONINSIGHTS_CONNECTION_STRING=InstrumentationKey=xxxx;IngestionEndpoint=https://<region>.in.applicationinsights.azure.com/


â¡ Restart cluster
â¡ Re-run notebook

âœ… STEP 2 â€” VERIFY YOU ARE QUERYING THE RIGHT RESOURCE

This is a very common mistake.

Check:

Are you opening Application Insights (not Log Analytics)?

Is it the same resource whose InstrumentationKey you used?

Run this query in Logs:
union customEvents, traces, requests
| order by timestamp desc


If empty â†’ continue.

âœ… STEP 3 â€” FORCE A SIMPLE TRACE (NOT EVENT)

Events are optional; traces are the simplest signal.

Run this minimal test:

import com.microsoft.applicationinsights.TelemetryClient

val tc = new TelemetryClient()
tc.trackTrace("ğŸ”¥ databricks-trace-test")
tc.flush()

Thread.sleep(15000)

println("Trace sent")


Now query:

traces
| where message contains "databricks-trace-test"
| order by timestamp desc

âŒ If still nothing â†’ ingestion/network issue confirmed.
âœ… STEP 4 â€” TEST AZURE MONITOR ENDPOINT CONNECTIVITY (CRITICAL)

Databricks often blocks outbound telemetry.

Run:

import java.net.URL
import scala.util.Try

Try {
  new URL("https://dc.services.visualstudio.com/v2/track").openConnection().connect()
}.fold(
  err => println("âŒ CANNOT CONNECT: " + err.getMessage),
  _   => println("âœ… Azure Monitor endpoint reachable")
)

âŒ If you see:
CANNOT CONNECT


â¡ THIS IS THE ROOT CAUSE

Fix required:

Enable outbound HTTPS (443)

If VNet injected â†’ NAT Gateway required

Azure Monitor endpoints must be reachable

ğŸ“Œ No SDK or code change can fix this

âœ… STEP 5 â€” ENABLE INTERNAL SDK DIAGNOSTICS

Add before creating TelemetryClient:

System.setProperty("applicationinsights.debug", "true")


Then re-run and check Driver Logs.

You should see logs like:

Transmission succeeded
Sending telemetry to ...


If you see retries or drops â†’ network.

âœ… STEP 6 â€” CONFIRM SDK VERSION IS LOADED

Run:

import com.microsoft.applicationinsights.BuildInfo
println(BuildInfo.VERSION)


Expected:

3.7.6


If this throws â†’ jar not loaded correctly.

ğŸš¨ MOST COMMON ROOT CAUSE (90% CASES)

Databricks outbound internet is blocked

Especially true if:

VNet injected workspace

Private endpoints

No NAT gateway

ğŸ“Œ Application Insights ingestion requires public outbound HTTPS

âœ… FINAL DECISION TREE
Test	Result	Meaning
ENV var missing	âŒ	Misconfigured cluster
Trace not visible	âŒ	Ingestion blocked
URL connect fails	âŒ	Network issue
Logs show retries	âŒ	Firewall / NAT
All pass but no data	âŒ	Wrong AppInsights resource
ğŸ”¥ Be honest with me:

Reply with only this:

1ï¸âƒ£ ENV var output
2ï¸âƒ£ URL connectivity result
3ï¸âƒ£ Trace query result

I will tell you exactly what is wrong and how to fix it.
