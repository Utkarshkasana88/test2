import com.azure.monitor.opentelemetry.autoconfigure.AzureMonitorAutoconfigure
import io.opentelemetry.api.GlobalOpenTelemetry
import io.opentelemetry.api.trace.Tracer
import io.opentelemetry.api.common.Attributes
import io.opentelemetry.api.metrics.Meter
import io.opentelemetry.api.metrics.common.Labels

object DatabricksAzureMonitorTest {

  def main(args: Array[String]): Unit = {

    try {
      println("=== Initializing Azure Monitor Autoconfigure ===")

      // This reads env vars automatically and sets up SDK + exporters
      AzureMonitorAutoconfigure.initialize()

      println("Azure Monitor OpenTelemetry initialized successfully")

      val tracer: Tracer = GlobalOpenTelemetry.getTracer("databricks-otel-tracer")
      val meter: Meter = GlobalOpenTelemetry.getMeter("databricks-otel-meter")

      // Send 5 test spans
      for (i <- 1 to 5) {
        val span = tracer.spanBuilder(s"custom-span-$i")
          .setAttribute("iteration", i)
          .startSpan()

        span.addEvent(
          "custom-event",
          Attributes.builder()
            .put("source", "databricks")
            .put("iteration", i)
            .build()
        )

        Thread.sleep(200)
        span.end()
        println(s"Sent span $i")
      }

      // Send a simple custom metric
      val counter = meter.counterBuilder("databricks_custom_counter")
        .setDescription("Demo custom metric")
        .setUnit("1")
        .build()

      counter.add(10, Labels.of("env", "databricks"))
      println("Custom metric sent")

      // Allow time for telemetry export
      Thread.sleep(5000)
      println("All telemetry sent successfully!")

    } catch {
      case ex: Throwable =>
        println("‚ùå Error initializing Azure Monitor OpenTelemetry")
        ex.printStackTrace()
    }
  }
}
