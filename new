import io.opentelemetry.api.metrics.Meter
import io.opentelemetry.api.metrics.LongCounter
import io.opentelemetry.api.common.Attributes
import com.azure.monitor.opentelemetry.autoconfigure.AutoConfiguredOpenTelemetrySdk

object CustomMetricExample {
  def main(args: Array[String]): Unit = {
    println("Starting custom metric example...")

    // Bootstraps OpenTelemetry from AUTOCONFIGURE
    val autoSdk = AutoConfiguredOpenTelemetrySdk.builder().build()
    val openTelemetry = autoSdk.getOpenTelemetrySdk()

    // Create a Meter
    val meter: Meter = openTelemetry.getMeter("scala-custom-metrics")

    // Create a LongCounter metric
    val requestCounter: LongCounter =
      meter.counterBuilder("request_count_total")
        .setDescription("Total number of requests processed")
        .setUnit("1")
        .build()

    println("Recording metric values...")

    // Record some metric values
    requestCounter.add(1, Attributes.builder().put("method", "GET").put("status", "200").build())
    requestCounter.add(1, Attributes.builder().put("method", "POST").put("status", "201").build())

    println("Metrics recorded. Waiting to export...")

    // Sleep briefly to allow metric exporter to export data
    Thread.sleep(65000) // must be >= metric export interval (e.g., 60s)

    println("Done.")
  }
}
